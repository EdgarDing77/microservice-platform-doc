# 项目设计

[toc]



## 需求分析

### 核心功能

1. 统一认证功能
   - 网关统一认证
   - url级权限控制
   - 支持oauth2
   - 支持用户名、密码、验证码登陆
   - 支持手机号、密码登陆
2. 分布式系统基础支撑
   - 服务注册发现、路由与负载均衡
   - 服务降级与熔断
   - 服务限流（url/方法级别）
   - 统一配置中心
   - 统一日志中心
   - 统一搜索中心
   - 统一分布式缓存操作类、cacheManager配置扩展
   - 分布式锁
   - 分布式ID生成器
   - 分布式事务（同步最终一致性）基于seata
   - （日志链路追踪）
3. 系统监控功能
   - 微服务服务监控
   - 服务实例监控（物理机监控）
   - （服务调用链监控）
   - redis监控
   - mysql监控
   - nacos监控
   - 服务限流、降级和熔断监控
   - 应用吞吐量监控（qps、rt）
   - 应用统一日志查询
4. 业务基础功能支撑
   - 多租户（应用隔离）
   - 高性能方法级幂等性支持
   - RBAC权限管理，实现细粒度控制（方法、URL级别）
   - 网关聚合所有Swagger接口文档
   - 统一异常处理
   - 统一跨域处理

### 背景和目标

- 基于Spring Cloud的微服务平台的实现与学习
- 需要通过Spring Cloud实现微服务的基础设施
- 结合Kubernetes对微服务架构进行未来展望
- 主要针对解决微服务和业务开发时常见的**非功能性需求**。

### 难点

难点概览：

1. 架构方面
   - Spring Cloud技术多而杂
   - 技术多样性，兼容性问题
   - 理论知识需要多
2. 实现方面
   - 各个细知识的运用细节，容易存在运用问题
   - 涉及技术面大，学习成本高
   - 编码涉及多种语言
3. 总结
   1. 技术杂、多而复杂，学习成本高
   2. 涉及面广，需要有全栈开发的基础

## 架构

**项目架构V1:**

![microservices-monitor](https://cdn.jsdelivr.net/gh/edgarding77/microservice-platform-doc@latest/image/microservices-monitor.jpg)

## 技术选型

### 组件选择

- 分布式系统套件版本：Spring Boot 2.x + Spring Cloud + Spring Cloud Alibaba
- 服务治理注册与发现：Spring Cloud Alibaba Nacos
- 统一配置中心：Spring Cloud Alibaba Nacos
- 服务降级、熔断和限流：Alibaba Sentinel
- 网关路由代理调用：Spring Cloud Gateway
- 声明式服务调用：Spring Cloud OpenFeign
- 服务负载均衡：Spring Cloud Netflix Ribbon
- 服务安全认证：Spring Security
- 数据访问层：Mybatis-plus
- 分布式事务：Alibaba Seata / RocketMQ
- 统一日志收集存储：ELK + Filebeat
- 服务应用监控：Spring Cloud Admin / Prometheus
- 服务调用链监控：Skywalking
- 分布式任务调度：XXL-JOB
- 全文搜索引擎：Elasticsearch
- 分库分表：Sharding-JDBC
- 容器管理平台：Rancher

### 组件对比

服务注册发现

- Nacos & Eureka
  - Eureka闭源，所以不做考虑
  - Nacos无缝对接和支持dubbo、spring cloud和Kubernetes云原生体系

配置中心

- Nacos & Apollo
  - Nacos缺点：功能上要少，主要体现在发布审计、灰度发布等功能
  - Nacos优点：支持yml格式，并且与注册中心是同一套组件，方便管理运维

服务降级、熔断和限流

- Sentinal & Hystrix
  - Hystrix停止更新
  - Sentinel功能比Hystrix多
    - 支持动态配置规则（业务无侵入）
    - 支持系统负载保护（根据自定义规则总体保护，不限于某个接口）
    - 完善的控制台（开箱即用、可配置规则、秒级监控、机器发现等）

