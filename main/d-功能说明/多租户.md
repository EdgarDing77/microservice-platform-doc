# 多租户



## Introduction

多租户技术或称多重租赁技术，简称`SaaS`，是一种软件架构技术，是实现如何在多用户环境下（此处的多用户一般是面向企业用户）共用相同的系统或程序组件，并且可确保各用户间数据的隔离性。

简单讲：在一台服务器上运行单个应用实例，它为多个租户（客户）提供服务。从定义中我们可以理解：多租户是一种架构，目的是为了让多用户环境下使用同一套程序，且保证用户间数据隔离。那么重点就很浅显易懂了，多租户的重点就是同一套程序下实现多用户数据的隔离。

## 数据隔离方案

![Image](https://cdn.jsdelivr.net/gh/edgarding77/microservice-platform-doc@latest/image/func/tenant-database.png)

主要存在三种方案：

1. 独立数据库

即一个租户一个数据库，隔离性最强，安全性也最好，但成本较高。

- 优点：为不同的租户提供独立的数据库，有助于简化数据模型的扩展设计，满足不同租户的独特需求；如果出现故障，恢复数据比较简单。
- 缺点：增多了数据库的安装数量，随之带来维护成本和购置成本的增加。
- 这种方案与传统的一个客户、一套数据、一套部署类似，差别只在于软件统一部署在运营商那里。如果面对的是银行、医院等需要非常高数据隔离级别的租户，可以选择这种模式，提高租用的定价。如果定价较低，产品走低价路线，这种方案一般对运营商来说是无法承受的。

2. 共享数据库，独立Schema

多个或所有租户共享Database，但是每个租户一个Schema。

- 优点：为安全性要求较高的租户提供了一定程度的逻辑数据隔离，并不是完全隔离；每个数据库可支持更多的租户数量。
- 缺点：如果出现故障，数据恢复比较困难，因为恢复数据库将牵涉到其他租户的数据。
- MySQL数据库的`Schema`等同于`Database`

3. 共享数据库，共享Schema，共享数据表

即租户共享同一个Database、同一个Schema，但在表中增加TenantID多租户的数据字段。这是共享程度最高、隔离级别最低的模式。

简单来讲，即每插入一条数据时都需要有一个客户的标识。这样才能在同一张表中区分出不同客户的数据。

- 优点：三种方案比较，第三种方案的维护和购置成本最低，允许每个数据库支持的租户数量最多。
- 缺点：隔离级别最低，安全性最低，需要在设计开发时加大对安全的开发量； 数据备份和恢复最困难，需要逐表逐条备份和还原。
- 如果希望以最少的服务器为最多的租户提供服务，并且租户接受牺牲隔离级别换取降低成本，这种方案最适合。

## 实现分析

衡量三种模式主要考虑的因素是`隔离`还是`共享`

- **成本角度因素**

  隔离性越好，设计和实现的难度和成本越高，初始成本越高。

  共享性越好，同一运营成本下支持的用户越多，运营成本越低。

- **安全因素**

  要考虑业务和客户的安全方面的要求。安全性要求越高，越要倾向于`隔离`。

- **从租户数量上考虑**

  系统要支持多少租户？上百？上千还是上万？可能的租户越多，越倾向于`共享`。

  平均每个租户要存储数据需要的空间大小。存贮的数据越多，越倾向于`隔离`。

  每个租户的同时访问系统的最终用户数量。需要支持的越多，越倾向于`隔离`。

  是否想针对每一租户提供附加的服务，例如数据的备份和恢复等。这方面的需求越多， 越倾向于`隔离`

- **技术储备**

  共享性越高，对技术的要求越高。

## 项目实现详解

项目选用第三种方案即`共享数据库，共享 Schema，共享数据表`来实现，每个需要隔离的数据表都要增加一个租户标识`tenant_id`

> 每条sql语句会自动加上 **tenant_id** 过滤条件

1. 目前数据库中需要添加该字段的表包括：`sys_menu`、`sys_role`、`file_info`
2. 业务的`curd`不需要关注租户标识，通过动态修改SQL的手段实现业务无感知

> 在该方案的基础上只需要增加`Sharding-jdbc`、`MyCat`等中间件即可实现第一种隔离方案

**关系图：**

![Image](https://cdn.jsdelivr.net/gh/edgarding77/microservice-platform-doc@latest/image/func/tenant-relation.png)

1. 本项目因为主要设计面向的是中台架构，所以用户数据是共享的并不会隔离，以实现多应用共享同一用户
2. 菜单、角色管理和token管理这3个功能(能看到所有租户的数据)，由管理员统一为各个租户维护数据，其他租户不需要看到这3个菜单

**流程图：**

![Image](https://cdn.jsdelivr.net/gh/edgarding77/microservice-platform-doc@latest/image/func/tenant-flow.png)

### 配置说明

添加一下配置到**需要数据隔离的服务**上即可：

```yaml
djj:
  tenant:
    enable: true # 是否开启多租户
    ignoreTables: # 配置不需要隔离的表
      - sys_user
      - sys_role_user
      - sys_role_menu
    ignoreSqls: # 配置不需要隔离的语句，直接配置MyBatis的Mapper全路径+SQLld
      - {}
```